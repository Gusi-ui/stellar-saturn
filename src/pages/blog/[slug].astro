---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Navigation from '../../components/Navigation.astro';
import { getCollection } from 'astro:content';
import { Calendar, User, Clock, Tag, Share2, X } from 'lucide-react';

// Get all blog posts
const blogPosts = await getCollection('blog');

// Sort posts by date (newest first) for navigation
const sortedPosts = blogPosts.sort(
  (a, b) => new Date(b.data.publishDate).getTime() - new Date(a.data.publishDate).getTime()
);

// Get the current post based on the slug
export async function getStaticPaths() {
  const blogEntries = await getCollection('blog');
  return blogEntries.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

export const prerender = true;

const { entry } = Astro.props;
const { Content } = await entry.render();

// Get related posts (same category, excluding current post)
const relatedPosts = blogPosts
  .filter((post) => post.data.category === entry.data.category && post.slug !== entry.slug)
  .slice(0, 3);

// Format reading time
const readingTime = entry.data.readingTime || Math.ceil(entry.body.split(' ').length / 200);

// Social sharing URLs
const shareUrl = Astro.url.href;
const shareText = encodeURIComponent(entry.data.description);
---

<BaseLayout title={entry.data.title} description={entry.data.description} image={entry.data.image}>
  <Navigation />

  <main id="main-content" class="flex-1">
    <!-- Article Header -->
    <section class="bg-linear-to-br from-blue-600 to-blue-800 text-white py-16">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="mb-6">
          <span
            class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-white/20 text-white backdrop-blur-sm"
          >
            {entry.data.category}
          </span>
        </div>

        <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold mb-6">
          {entry.data.title}
        </h1>

        <p class="text-xl text-blue-100 mb-8">
          {entry.data.description}
        </p>

        <div class="flex flex-wrap items-center gap-6 text-blue-100">
          <div class="flex items-center">
            <User className="w-5 h-5 mr-2" />
            <span>{entry.data.author}</span>
          </div>

          <div class="flex items-center">
            <Calendar className="w-5 h-5 mr-2" />
            <time datetime={entry.data.publishDate.toISOString()}>
              {
                entry.data.publishDate.toLocaleDateString('es-ES', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric',
                })
              }
            </time>
          </div>

          <div class="flex items-center">
            <Clock className="w-5 h-5 mr-2" />
            <span>{readingTime} min de lectura</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Article Content -->
    <section class="py-12">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <!-- Main Content -->
          <div class="lg:col-span-2">
            <article class="prose prose-lg max-w-none">
              {
                entry.data.image && (
                  <div class="mb-8">
                    <img
                      src={entry.data.image}
                      alt={entry.data.altText || entry.data.title}
                      class="w-full h-auto rounded-lg shadow-md"
                    />
                    {entry.data.altText && (
                      <p class="text-sm text-gray-600 mt-2 text-center italic">
                        {entry.data.altText}
                      </p>
                    )}
                  </div>
                )
              }

              <div class="text-gray-700 leading-relaxed">
                <Content />
              </div>
            </article>

            <!-- Tags -->
            {
              entry.data.tags && entry.data.tags.length > 0 && (
                <div class="mt-8 pt-8 border-t border-gray-200">
                  <h3 class="text-sm font-medium text-gray-900 mb-4 flex items-center">
                    <Tag className="w-4 h-4 mr-2" />
                    Etiquetas
                  </h3>
                  <div class="flex flex-wrap gap-2">
                    {entry.data.tags.map((tag) => (
                      <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">
                        #{tag}
                      </span>
                    ))}
                  </div>
                </div>
              )
            }

            <!-- Share Section -->
            <div class="mt-8 pt-8 border-t border-gray-200">
              <h3 class="text-sm font-medium text-gray-900 mb-4 flex items-center">
                <Share2 className="w-4 h-4 mr-2" />
                Compartir artículo
              </h3>
              <div class="flex space-x-4">
                <a
                  href={`https://x.com/intent/post?text=${shareText}&url=${shareUrl}`}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="inline-flex items-center px-4 py-2 bg-blue-400 text-white rounded-md hover:bg-blue-500 transition-colors"
                  aria-label="Compartir en X"
                >
                  <X className="w-4 h-4 mr-2" />
                  X
                </a>

                <button
                  onclick={`navigator.share({ title: '${entry.data.title}', text: '${entry.data.description}', url: '${shareUrl}' })`}
                  class="inline-flex items-center px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors"
                  aria-label="Compartir"
                >
                  <Share2 className="w-4 h-4 mr-2" />
                  Compartir
                </button>
              </div>
            </div>
          </div>

          <!-- Sidebar -->
          <aside class="lg:col-span-1">
            <!-- Author Info -->
            <div class="bg-gray-50 rounded-lg p-6 mb-8">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">Autor</h3>
              <div class="flex items-center mb-4">
                <div
                  class="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center"
                >
                  <User className="w-6 h-6" />
                </div>
                <div class="ml-3">
                  <p class="font-medium text-gray-900">{entry.data.author}</p>
                  <p class="text-sm text-gray-600">DiverMataró</p>
                </div>
              </div>
              <p class="text-sm text-gray-600">
                Trabajamos por una sociedad más inclusiva y accesible para todas las personas.
              </p>
            </div>

            <!-- Related Posts -->
            {
              relatedPosts.length > 0 && (
                <div class="bg-gray-50 rounded-lg p-6">
                  <h3 class="text-lg font-semibold text-gray-900 mb-4">Artículos relacionados</h3>
                  <div class="space-y-4">
                    {relatedPosts.map((post) => (
                      <article class="border-b border-gray-200 pb-4 last:border-b-0 last:pb-0">
                        <h4 class="font-medium text-gray-900 mb-2">
                          <a
                            href={`/blog/${post.slug}`}
                            class="hover:text-blue-600 transition-colors"
                          >
                            {post.data.title}
                          </a>
                        </h4>
                        <p class="text-sm text-gray-600 line-clamp-2">{post.data.description}</p>
                        <time class="text-xs text-gray-500 mt-1 block">
                          {post.data.publishDate.toLocaleDateString('es-ES')}
                        </time>
                      </article>
                    ))}
                  </div>
                </div>
              )
            }
          </aside>
        </div>
      </div>
    </section>

    <!-- Navigation -->
    <section class="py-8 bg-gray-50 border-t">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center">
          <a
            href="/blog/"
            class="inline-flex items-center px-4 py-2 text-blue-600 hover:text-blue-800 font-medium"
          >
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 19l-7-7 7-7"></path>
            </svg>
            Volver al blog
          </a>

          <div class="flex space-x-2">
            {
              sortedPosts.map((post, index) => {
                if (post.slug === entry.slug) {
                  const prevPost = sortedPosts[index - 1];
                  const nextPost = sortedPosts[index + 1];

                  return (
                    <>
                      {prevPost && (
                        <a
                          href={`/blog/${prevPost.slug}`}
                          class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                          title={`Anterior: ${prevPost.data.title}`}
                        >
                          <svg
                            class="w-4 h-4 mr-2"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M15 19l-7-7 7-7"
                            />
                          </svg>
                          Anterior
                        </a>
                      )}

                      {nextPost && (
                        <a
                          href={`/blog/${nextPost.slug}`}
                          class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                          title={`Siguiente: ${nextPost.data.title}`}
                        >
                          Siguiente
                          <svg
                            class="w-4 h-4 ml-2"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M9 5l7 7-7 7"
                            />
                          </svg>
                        </a>
                      )}
                    </>
                  );
                }
                return null;
              })
            }
          </div>
        </div>
      </div>
    </section>
  </main>
</BaseLayout>
